<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Qwen3-TTS Inno France</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/unified_styles.css') }}">
  </head>
  <body>
    <main class="container">
      <header class="header">
        <div class="brand">Qwen3-TTS Inno France</div>
        <div class="subtitle">基于Qwen3-TTS的产品级语音合成解决方案</div>
      </header>

      <section class="card">
        <div class="tabs">
          <button class="tab-button active" data-tab="voice-design">声音设计</button>
          <button class="tab-button" data-tab="voice-clone">声音克隆</button>
        </div>

        <div class="tab-content">
          <!-- 声音设计 Tab -->
          <div id="voice-design" class="tab-pane active">
            <form id="design-form" enctype="multipart/form-data">
              <div class="form-group">
                <label class="label" for="design-text">文本内容:</label>
                <textarea id="design-text" name="text" class="textarea" placeholder="请输入要合成的文本..." required></textarea>
              </div>

              <div class="row">
                <div class="form-group">
                  <label class="label" for="design-language">语言:</label>
                  <select id="design-language" name="language" class="select" required>
                    <option value="Chinese">中文</option>
                    <option value="English">英文</option>
                    <option value="Japanese">日文</option>
                    <option value="Korean">韩文</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="label" for="design-speed">播放速度:</label>
                  <input type="range" id="design-speed" name="speed" class="range-input" min="1.0" max="2.0" step="0.1" value="1.0">
                  <span id="design-speed-value" class="range-value">1.0</span>
                </div>
              </div>

              <div class="form-group">
                <label class="label" for="design-instruct">声音描述:</label>
                <input type="text" id="design-instruct" name="instruct" class="input" placeholder="例如：年轻女性声音，语调活泼" required>
              </div>


              <button id="design-btn" class="button" type="submit">生成声音</button>
            </form>

            <div id="design-result" class="result-section" style="display: none;">
              <h3>生成结果</h3>
              <audio id="design-audio" class="audio-player" controls></audio>
              <a id="design-download" class="download-link" download>下载音频文件</a>
            </div>
          </div>

          <!-- 声音克隆 Tab -->
          <div id="voice-clone" class="tab-pane">
            <form id="clone-form" enctype="multipart/form-data">
              <div class="form-group">
                <label class="label" for="clone-text">文本内容 (使用[SPEAKER0]、[SPEAKER1]等标记):</label>
                <textarea id="clone-text" name="text" class="textarea" placeholder="请输入要合成的文本，使用说话人标记..." required></textarea>
              </div>

              <div class="form-group">
                <label class="label" for="clone-speakers">说话人配置 (JSON格式):</label>
                <textarea id="clone-speakers" name="speaker_configs" class="textarea" placeholder='[{"design_text": "参考文本", "design_instruct": "声音描述", "language": "Chinese"}]' required></textarea>
              </div>

              <div class="row">
                <div class="form-group">
                  <label class="label" for="clone-speed">播放速度:</label>
                  <input type="range" id="clone-speed" name="speed" class="range-input" min="1.0" max="2.0" step="0.1" value="1.0">
                  <span id="clone-speed-value" class="range-value">1.0</span>
                </div>

              </div>

              <button id="clone-btn" class="button" type="submit">克隆声音</button>
            </form>

            <div id="clone-result" class="result-section" style="display: none;">
              <h3>生成结果</h3>
              <audio id="clone-audio" class="audio-player" controls></audio>
              <a id="clone-download" class="download-link" download>下载音频文件</a>
            </div>
          </div>
        </div>
      </section>

      <footer class="footer">
        <div>&copy; 2026 Inno France. All rights reserved.</div>
      </footer>
    </main>

    <script>
      // Tab切换功能
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
          // 移除所有激活状态
          document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
          
          // 激活当前标签
          button.classList.add('active');
          const tabId = button.getAttribute('data-tab');
          document.getElementById(tabId).classList.add('active');
        });
      });

      // 速度滑块值显示
      document.getElementById('design-speed').addEventListener('input', function() {
        document.getElementById('design-speed-value').textContent = this.value;
      });

      document.getElementById('clone-speed').addEventListener('input', function() {
        document.getElementById('clone-speed-value').textContent = this.value;
      });

      // 声音设计功能
      document.getElementById('design-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const button = document.getElementById('design-btn');
        const originalText = button.textContent;
        const resultSection = document.getElementById('design-result');
        
        try {
          button.textContent = '生成中...';
          button.disabled = true;
          
          // 显示加载状态
          resultSection.innerHTML = '<div class="loading"><div class="spinner"></div><div>正在生成声音...</div></div>';
          resultSection.style.display = 'block';
          
          // 创建FormData对象
          const formData = new FormData(this);
          
          const response = await fetch('/voice-design', {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            // 处理音频数据流
            const blob = await response.blob();
            const audioUrl = URL.createObjectURL(blob);
            
            // 显示结果
            resultSection.innerHTML = `
              <h3>生成结果</h3>
              <audio id="design-audio" class="audio-player" controls>
                <source src="${audioUrl}" type="audio/wav">
              </audio>
              <a id="design-download" class="download-link" href="${audioUrl}" download="output_voice_design.wav">下载音频文件</a>
            `;
            resultSection.style.display = 'block';
          } else {
            // 尝试解析错误响应
            try {
              const errorResult = await response.json();
              resultSection.innerHTML = `<div class="statusText err">错误: ${errorResult.detail}</div>`;
            } catch (e) {
              resultSection.innerHTML = `<div class="statusText err">请求失败: ${response.statusText}</div>`;
            }
          }
        } catch (error) {
          resultSection.innerHTML = `<div class="statusText err">网络错误: ${error.message}</div>`;
        } finally {
          button.textContent = originalText;
          button.disabled = false;
        }
      });

      // 声音克隆功能
      document.getElementById('clone-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const button = document.getElementById('clone-btn');
        const originalText = button.textContent;
        const resultSection = document.getElementById('clone-result');
        
        try {
          button.textContent = '克隆中...';
          button.disabled = true;
          
          // 显示加载状态
          resultSection.innerHTML = '<div class="loading"><div class="spinner"></div><div>正在克隆声音...</div></div>';
          resultSection.style.display = 'block';
          
          // 验证JSON格式
          const speakersText = document.getElementById('clone-speakers').value;
          try {
            JSON.parse(speakersText);
          } catch (e) {
            resultSection.innerHTML = `<div class="statusText err">说话人配置格式错误，请检查JSON格式</div>`;
            button.textContent = originalText;
            button.disabled = false;
            return;
          }
          
          // 创建FormData对象
          const formData = new FormData(this);
          
          const response = await fetch('/voice-clone', {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            // 处理音频数据流
            const blob = await response.blob();
            const audioUrl = URL.createObjectURL(blob);
            
            // 显示结果
            resultSection.innerHTML = `
              <h3>生成结果</h3>
              <audio id="clone-audio" class="audio-player" controls>
                <source src="${audioUrl}" type="audio/wav">
              </audio>
              <a id="clone-download" class="download-link" href="${audioUrl}" download="output_voice_clone.wav">下载音频文件</a>
            `;
            resultSection.style.display = 'block';
          } else {
            // 尝试解析错误响应
            try {
              const errorResult = await response.json();
              resultSection.innerHTML = `<div class="statusText err">错误: ${errorResult.detail}</div>`;
            } catch (e) {
              resultSection.innerHTML = `<div class="statusText err">请求失败: ${response.statusText}</div>`;
            }
          }
        } catch (error) {
          resultSection.innerHTML = `<div class="statusText err">网络错误: ${error.message}</div>`;
        } finally {
          button.textContent = originalText;
          button.disabled = false;
        }
      });

      // 初始化显示第一个标签页的内容
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelector('.tab-content').classList.add('active');
        document.getElementById('voice-design').classList.add('active');
      });
    </script>
  </body>
</html>